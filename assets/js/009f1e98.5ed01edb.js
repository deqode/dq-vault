"use strict";(self.webpackChunkdq_vault=self.webpackChunkdq_vault||[]).push([[436],{6154:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return r},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return p},default:function(){return d}});var n=a(7462),l=a(3366),i=(a(7294),a(3905)),o=["components"],r={sidebar_position:2},s=void 0,u={unversionedId:"getting-started/configuration",id:"getting-started/configuration",isDocsHomePage:!1,title:"configuration",description:"Set up postgres",source:"@site/docs/getting-started/configuration.md",sourceDirName:"getting-started",slug:"/getting-started/configuration",permalink:"/dq-vault/docs/getting-started/configuration",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/getting-started/configuration.md",version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"installation",permalink:"/dq-vault/docs/getting-started/installation"},next:{title:"plugin-usage",permalink:"/dq-vault/docs/guides/plugin-usage"}},p=[{value:"Set up postgres",id:"set-up-postgres",children:[]},{value:"Populate config file",id:"populate-config-file",children:[]},{value:"Vault Setup",id:"vault-setup",children:[]},{value:"Enable plugin",id:"enable-plugin",children:[]},{value:"Creating policies for application server",id:"creating-policies-for-application-server",children:[]},{value:"Enable userpass authentication method",id:"enable-userpass-authentication-method",children:[]}],c={toc:p};function d(e){var t=e.components,a=(0,l.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"set-up-postgres"},"Set up postgres"),(0,i.kt)("p",null,"Assuming that you have PostgreSQL installed in your system, you need to create a table which will be used by Vault to\nstore it's encrypted data."),(0,i.kt)("p",null,"Once you are into PostgreSQL shell prompt, run the following commands to create a table:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'  postgres=# create database vault;\n\n  postgres=# \\c vault\n\n  vault=# CREATE TABLE vault_kv_store (\n  parent_path TEXT COLLATE "C" NOT NULL,\n  path        TEXT COLLATE "C",\n  key         TEXT COLLATE "C",\n  value       BYTEA,\n  CONSTRAINT pkey PRIMARY KEY (path,key)\n  );\n\n  vault=# CREATE INDEX parent_path_idx ON vault_kv_store (parent_path);\n')),(0,i.kt)("h2",{id:"populate-config-file"},"Populate config file"),(0,i.kt)("p",null,"This is the step where we define the vault configurations. Vault supports .hcl files to write your configurations and\nset-up vault accordingly."),(0,i.kt)("p",null,"Given below is an example of a config.hcl file:"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"config.hcl"),"-"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},' disable_mlock = true\n ui            = true\n\n storage "postgresql" {\n   connection_url = "postgres://role:password@localhost:5432/databaseName?sslmode=disable"\n   table = "tableName"\n }\n\n \n listener "tcp" {\n  address     = "127.0.0.1:8200"\n  tls_disable = "true"\n }\n\n plugin_directory = "/$HOME/etc/vault/plugins/vault_plugin"\n api_addr = "http://127.0.0.1:8200"\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"config.hcl")," without postgres storage-"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},' disable_mlock = true\n ui            = true\n\n listener "tcp" {\n  address     = "127.0.0.1:8200"\n  tls_disable = "true"\n }\n\n storage "file" {\n  path = "/$HOME/etc/tmp/vault-data"\n }\n\n plugin_directory = "/$HOME/etc/vault/plugins/vault_plugin"\n api_addr = "http://127.0.0.1:8200"\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"api_addr")," defines the access port of vault. All the requests to vault will be done via this port.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Storage")," defines the backend-storage type that vault will use to store all the encrypted data. Since this\nbackend-storage is not a part of the vault, we define the access port of PostgreSQL server and the table name which is\nalready created. Change the role, password, databaseName, and tableName according to your postgres parameters. ",(0,i.kt)("strong",{parentName:"p"},"Note\nthat we have disabled SSL for database requests"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"listener")," part we have disabled TLS. If activated, TLS certificates and keys have to be provided here also.\nThe example above listens on localhost port 8200 without TLS.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Lastly, we have defined the ",(0,i.kt)("inlineCode",{parentName:"p"},"plugin directory")," where the vault looks for plugins. Remember to change this according to\nyour desired path where you stored the Vault bin file earlier."))),(0,i.kt)("h2",{id:"vault-setup"},"Vault Setup"),(0,i.kt)("p",null,"Once you have created the config.hcl configuration file, we can now start our vault server. Open the terminal in the\nfolder containing the config file and start the server by running the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"    $ sudo vault server -config=config.hcl\n")),(0,i.kt)("p",null,"Now that the vault server is up and running, it is actually in a sealed state, that is vault functionalities can't be\naccessed yet. To access vault we need to unseal it. First, open another terminal window and initialize vault by running\nthe following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"    $ export VAULT_ADDR='http://127.0.0.1:8200'\n\n    $ vault operator init\n")),(0,i.kt)("p",null,"The first command is required for non-TLS mode. The output is a set of 5 shamir keys which have the capability to unseal\nvault and an initial root token. Here vault is initialized in such a way that any 3 keys out of 5 are enough to unseal\nvault. The root token is used to login into the vault. Only after logging in, you can start using vault. Store these in\na safe place for later use."),(0,i.kt)("p",null,"Start the unsealing process by running the command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"    $ vault operator unseal\n")),(0,i.kt)("p",null,"The vault will ask you for an unseal key. Provide any one of the above 5. Run this command two more times and provide\ntwo other keys. Vault should be unsealed now. To verify run the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"    $ vault status\n")),(0,i.kt)("p",null,"The output should be something like this"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"  Key             Value\n  ---             -----\n  Seal Type       shamir\n  Sealed          false <----this\n  Total Shares    5\n  Threshold       3\n  Version         0.11.0\n  Cluster Name    vault-cluster-8dea58da\n  Cluster ID      8ac011b1-a830-663f-715a-cf5b3f87ae54\n  HA Enabled      false\n")),(0,i.kt)("p",null,"If you see the sealed key to have value false, vault is unsealed."),(0,i.kt)("p",null,"Now it's time to log in as the root admin. Run the command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"    $ vault login 85de6efd-d036-9f0d-1c64-5e18e63adee9\n")),(0,i.kt)("p",null,"Provide your ",(0,i.kt)("inlineCode",{parentName:"p"},"root-token")," in the above command and you should be logged in to vault as admin. Now we can send requests\nto vault and set-up our plugin."),(0,i.kt)("h2",{id:"enable-plugin"},"Enable plugin"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"If you previously have enabled this plugin, you need to disable it."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"  $ vault secrets disable /api\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Calculate the SHA256 of the plugin and register it in Vault's plugin catalog."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},'  $ export SHA256=$(shasum -a 256 "/etc/vault/plugins/vault_plugin" | cut -d\' \' -f1)\n\n  $ vault write sys/plugins/catalog/secrets-api \\\n      sha_256="${SHA256}" \\\n      command="vault_plugin"\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Mount the secrets engine"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},'  $ vault secrets enable \\\n    -path="api" \\\n    -plugin-name="secrets-api" \\\n    plugin\n')))),(0,i.kt)("h2",{id:"creating-policies-for-application-server"},"Creating policies for application server"),(0,i.kt)("p",null,"We need to define policies for the application server that will be using our vault. We don't want our application server\nto have complete root access of vault, rather, it should just have the capability to update our Vault API plugin that we\njust enabled. For that, we need to create another .hcl file (application.hcl as an example) to define the policies."),(0,i.kt)("p",null,"application.hcl:-"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'  path "api/*"\n  {\n    capabilities = ["read", "update"]\n  }\n')),(0,i.kt)("p",null,"To register this policy in vault, open terminal in the directory containing application.hcl and run the following\ncommand:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"  $ vault policy write application application.hcl\n")),(0,i.kt)("p",null,"Now we can use application policy to define access capabilities of anyone using vault. More on that later."),(0,i.kt)("h2",{id:"enable-userpass-authentication-method"},"Enable userpass authentication method"),(0,i.kt)("p",null,"We want our application server to login into vault using a particular ",(0,i.kt)("inlineCode",{parentName:"p"},"username")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"password")," and should have access\ncapabilities defined by the ",(0,i.kt)("inlineCode",{parentName:"p"},"application")," policy we created earlier. In order to do this we will be enabling userpass\nauthentication method."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"  $ vault auth enable userpass\n")),(0,i.kt)("p",null,'We then create a username and password using which our application server will log in. We also attach the application\npolicy in this command. The following command creates a user with username-"appserver" and password-"secret" with\napplication policy attached:'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"  $ vault write auth/userpass/users/appserver password=secret policies=application\n")),(0,i.kt)("p",null,"We then give these credentials to the application server, who will use this username and password to login into the\nvault. Note that anyone logged in by this method will have capabilities defined by the application policy."),(0,i.kt)("p",null,"We can easily create multiple user login credentials for different application servers."))}d.isMDXComponent=!0}}]);